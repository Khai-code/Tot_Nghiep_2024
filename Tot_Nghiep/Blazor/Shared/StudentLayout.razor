@using global::Data.DTOs
@inherits LayoutComponentBase
@inject IJSRuntime jsRuntime
@inject HttpClient httpclient
@inject NavigationManager navigate

<main>
    <div class="row">
        <div class="col-2">
            <div class="container-fluid shadow min-vh-100 bg-light">
                <div class="d-flex justify-content-center">
                    <img src="img/Rectangle89.png" style="height:150px" alt="Alternate Text" />
                </div>
                <div>
                    <nav class="flex-column justify-content-center" style="font-family:Arial; color:rgba(22, 105, 135, 1);">
                        <!-- Trang chủ -->
                        <div class="nav-item p-1">
                            <NavLink class="nav-link p-1" href="#" aria-hidden="true">
                                <i class="bi bi-house-door text-primary fs-4 m-1"></i>Trang chủ
                            </NavLink>
                        </div>

                        <!-- Điểm có sub-menu -->
                        <div class="nav-item p-1">
                            <NavLink class="nav-link p-1 d-flex align-items-center justify-content-between" href="#" aria-hidden="true" data-bs-toggle="collapse" data-bs-target="#diemMenu" aria-expanded="false" aria-controls="diemMenu">
                                <span>
                                    <i class="bi bi-mortarboard text-primary fs-4 m-1"></i>Điểm
                                </span>
                                <i class="bi bi-chevron-down text-primary fs-5"></i>
                            </NavLink>
                            <!-- Sub-menu -->
                            <div id="diemMenu" class="collapse mt-1">
                                <ul class="list-group border-0">
                                    <li class="list-group-item border-0 ps-4" style="background-color: rgba(245, 245, 245, 1);">
                                        <a class="nav-link text-dark d-flex align-items-center" href="#">
                                            <i class="bi bi-list-check text-primary fs-5 me-2"></i>Điểm theo môn
                                        </a>
                                    </li>
                                    <li class="list-group-item border-0 ps-4" style="background-color: rgba(245, 245, 245, 1);">
                                        <a class="nav-link text-dark d-flex align-items-center" href="#">
                                            <i class="bi bi-pie-chart text-primary fs-5 me-2"></i>Điểm tổng
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Thi online -->
                        <div class="nav-item p-1">
                            <NavLink class="nav-link p-1" href="manage-test" aria-hidden="true">
                                <i class="bi bi-book text-primary fs-4 m-1"></i>Thi online
                            </NavLink>
                        </div>

                        <!-- Liên hệ -->
                        <div class="nav-item p-1">
                            <NavLink class="nav-link p-1" href="contectstudent" aria-hidden="true">
                                <i class="bi bi-card-checklist text-primary fs-4 m-1"></i>Liên hệ
                            </NavLink>
                        </div>
                    </nav>
                </div>



            </div>
        </div>
        <div class="col-10">
            <div class="row">
                <nav>
                    <div class=" bg-light shadow-sm " style="height:100px">
                        <div class="d-flex justify-content-end container align-items-center pt-2">
                            <i class="bi bi-person-circle fs-2 text-primary"></i>
                            @if (tokenResponse != null)
                            {
                                <span class="nav-link fw-bold text-black-50 p-2">@ShortenContent(userName, 15)</span>
                                <navlink href="#" @onclick="HandleLogout" class="nav-link fw-bold text-black-50 p-2">đăng xuất</navlink>
                            }
                        </div>
                        <hr />
                    </div>
                </nav>
            </div>
            <div class="row">
                <article class="container">
                    @Body
                </article>
            </div>
        </div>
    </div>
</main>

@code {
    private TokenResponse tokenResponse;
    private string userName;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var token = await jsRuntime.InvokeAsync<string>("localStorage.getItem", "YourSuperSecretKeyHere");

            if (!string.IsNullOrEmpty(token))
            {
                tokenResponse = new TokenResponse { Token = token };
                var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();
                var jsonToken = handler.ReadToken(token) as System.IdentityModel.Tokens.Jwt.JwtSecurityToken;
                userName = jsonToken?.Claims.FirstOrDefault(c => c.Type == "name")?.Value;
                StateHasChanged();
            }
        }
    }
    private async Task HandleLogout()
    {
        var response = await httpclient.PostAsync("api/User/logout", null);

        if (response.IsSuccessStatusCode)
        {
            await jsRuntime.InvokeVoidAsync("localStorage.removeItem", "YourSuperSecretKeyHere");
            tokenResponse = null;
            userName = null;
            navigate.NavigateTo("/");
        }
    }
    private string ShortenContent(string content, int maxLength)
    {
        if (string.IsNullOrEmpty(content))
        {
            return content;
        }
        return content.Length > maxLength ? content.Substring(0, maxLength) + "..." : content;
    }
}

<style>
    .row {
        --bs-gutter-x: 0;
    }
</style>
